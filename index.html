<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Form Data Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }

    h2 {
      text-align: center;
    }

    .controls {
      text-align: center;
      margin-bottom: 20px;
    }

    select, button, input[type=range] {
      margin: 6px;
      padding: 6px 10px;
    }

    .chart-wrapper {
      max-width: 1200px;
      margin: 30px auto;
    }

    .chart-container {
      width: 100%;
      height: 400px;
      margin-bottom: 40px;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>

<body>

<h2>Form Data Dashboard</h2>

<div class="controls">
  <label>X-axis:</label>
  <select id="xSelect"></select>

  <label>Y-axis:</label>
  <select id="ySelect"></select>

  <label>Chart:</label>
  <select id="chartType">
    <option value="bar">Bar</option>
    <option value="line">Line</option>
  </select>

  <button id="refreshBtn">Refresh Data</button>
  <button id="addChartBtn">Add Another Chart</button>
</div>

<div class="controls">
  <label>Chart Height:</label>
  <input type="range" id="sizeSlider" min="300" max="800" value="400">
  <span id="sizeValue">400px</span>
</div>

<div id="charts" class="chart-wrapper"></div>

<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbyn27BCQpW5oMmQHPEnr9256TTiMP449DT1cq8Uz4vXXI335XBocCS2NYsf-3lXVVG0AQ/exec";

let charts = [];
let chartCount = 0;
let cachedData = null;

async function fetchData() {
  const res = await fetch(apiUrl);
  const data = await res.json();

  const headers = Object.keys(data[0]);
  const dataRows = data.map(obj => Object.values(obj));

  cachedData = { headers, dataRows };
  return cachedData;
}

function populateSelectors(headers) {
  const xSelect = document.getElementById('xSelect');
  const ySelect = document.getElementById('ySelect');

  xSelect.innerHTML = '';
  ySelect.innerHTML = '';

  headers.forEach((h, i) => {
    xSelect.add(new Option(h, i));
    ySelect.add(new Option(h, i));
  });

  xSelect.selectedIndex = 0;
  ySelect.selectedIndex = 1;
}

function createChart() {
  const container = document.createElement('div');
  container.className = 'chart-container';
  container.style.height = document.getElementById('sizeSlider').value + 'px';

  const canvas = document.createElement('canvas');
  canvas.id = 'chart' + chartCount++;

  container.appendChild(canvas);
  document.getElementById('charts').appendChild(container);

  renderChart(canvas);
}

function renderChart(canvas) {
  const { headers, dataRows } = cachedData;

  const xIndex = document.getElementById('xSelect').value;
  const yIndex = document.getElementById('ySelect').value;
  const type = document.getElementById('chartType').value;

  const labels = dataRows.map(r => r[xIndex]);
  const values = dataRows.map(r => parseFloat(r[yIndex]) || 0);

  const chart = new Chart(canvas.getContext('2d'), {
    type,
    data: {
      labels,
      datasets: [{
        label: headers[yIndex],
        data: values,
        tension: 0.3,
        backgroundColor: 'rgba(54,162,235,0.5)',
        borderColor: 'rgba(54,162,235,1)',
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });

  charts.push({ chart, container: canvas.parentElement });
}

function refreshCharts() {
  charts.forEach(c => c.chart.destroy());
  charts = [];
  document.getElementById('charts').innerHTML = '';
  createChart();
}

document.getElementById('refreshBtn').onclick = async () => {
  await fetchData();
  refreshCharts();
};

document.getElementById('addChartBtn').onclick = createChart;

document.getElementById('chartType').onchange = refreshCharts;
document.getElementById('xSelect').onchange = refreshCharts;
document.getElementById('ySelect').onchange = refreshCharts;

document.getElementById('sizeSlider').oninput = (e) => {
  document.getElementById('sizeValue').innerText = e.target.value + 'px';
  charts.forEach(c => c.container.style.height = e.target.value + 'px');
};

async function init() {
  const { headers } = await fetchData();
  populateSelectors(headers);
  createChart();
}

init();
</script>

</body>
</html>
