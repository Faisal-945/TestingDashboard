<!DOCTYPE html>
<html>
<head>
  <title>Form Data Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <style>
    body { font-family: Arial; margin: 30px; }
    h2 { text-align: center; }

    .chart-box {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin: 25px auto;
      max-width: 1200px;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    .chart-container {
      position: relative;
      height: 450px;
      width: 100%;
    }

    button { cursor: pointer; }
  </style>
</head>
<body>

<h2>Form Data Dashboard</h2>
<button onclick="addChart()">âž• Add Chart</button>

<div id="charts"></div>

<script>
const apiUrl =
  "https://script.google.com/macros/s/AKfycbyn27BCQpW5oMmQHPEnr9256TTiMP449DT1cq8Uz4vXXI335XBocCS2NYsf-3lXVVG0AQ/exec";

let chartId = 0;
const chartStates = new Map();

/* ---------- HELPERS ---------- */
function parseTimestamp(value) {
  if (!value) return null;

  if (!isNaN(Date.parse(value))) return new Date(value);

  // DD/MM/YYYY HH:mm:ss
  const [date, time] = value.split(" ");
  const [d, m, y] = date.split("/");
  return new Date(`${y}-${m}-${d}T${time}`);
}

async function fetchData() {
  const res = await fetch(apiUrl);
  return await res.json();
}

function isNumeric(data, key) {
  for (let i = 0; i < Math.min(5, data.length); i++) {
    if (isNaN(parseFloat(data[i][key]))) return false;
  }
  return true;
}

/* ---------- CREATE CHART ---------- */
async function addChart() {
  const data = await fetchData();
  const headers = Object.keys(data[0]);

  const timestampKey = headers.find(h =>
    h.toLowerCase().includes("time") ||
    h.toLowerCase().includes("date")
  );

  if (!timestampKey) {
    alert("No timestamp column found!");
    return;
  }

  const id = ++chartId;

  const box = document.createElement("div");
  box.className = "chart-box";
  box.id = `chart-${id}`;

  box.innerHTML = `
    <div class="controls">
      <label>Y-axis
        <select class="y"></select>
      </label>

      <label>Chart Type
        <select class="type">
          <option value="line">Line</option>
          <option value="bar">Bar</option>
        </select>
      </label>

      <label>Show last
        <input class="timeValue" type="number" value="60" min="1">
      </label>

      <label>Unit
        <select class="timeUnit">
          <option value="60000">Minutes</option>
          <option value="3600000">Hours</option>
        </select>
      </label>

      <label>Refresh
        <select class="refresh">
          <option value="0">Off</option>
          <option value="5000">5s</option>
          <option value="10000">10s</option>
          <option value="30000">30s</option>
        </select>
      </label>

      <button class="delete">ðŸ—‘ Delete</button>
    </div>

    <div class="chart-container">
      <canvas></canvas>
    </div>
  `;

  document.getElementById("charts").appendChild(box);

  const ySel = box.querySelector(".y");
  headers.forEach(h => {
    if (isNumeric(data, h)) ySel.add(new Option(h, h));
  });

  const state = {
    id,
    box,
    canvas: box.querySelector("canvas"),
    chart: null,
    timer: null,
    timestampKey
  };

  chartStates.set(id, state);

  box.querySelectorAll("select, input").forEach(el =>
    el.addEventListener("change", () => rebuildChart(id))
  );

  box.querySelector(".delete").onclick = () => removeChart(id);

  rebuildChart(id);
}

/* ---------- BUILD / UPDATE ---------- */
async function rebuildChart(id) {
  const state = chartStates.get(id);
  if (!state) return;

  if (state.timer) clearInterval(state.timer);

  const box = state.box;
  const yKey = box.querySelector(".y").value;
  const type = box.querySelector(".type").value;
  const timeValue = +box.querySelector(".timeValue").value;
  const timeUnit = +box.querySelector(".timeUnit").value;
  const refresh = +box.querySelector(".refresh").value;

  const windowMs = timeValue * timeUnit;

  async function draw() {
    const raw = await fetchData();
    const now = Date.now();

    const points = raw
      .map(r => ({
        x: parseTimestamp(r[state.timestampKey]),
        y: parseFloat(r[yKey])
      }))
      .filter(p =>
        p.x instanceof Date &&
        !isNaN(p.y) &&
        (now - p.x.getTime()) <= windowMs
      );

    if (state.chart) state.chart.destroy();

    state.chart = new Chart(state.canvas, {
      type,
      data: {
        datasets: [{
          label: yKey,
          data: points,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: "time",
            time: {
              tooltipFormat: "HH:mm:ss"
            },
            title: { display: true, text: "Time" }
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: yKey }
          }
        }
      }
    });
  }

  await draw();

  if (refresh > 0) {
    state.timer = setInterval(draw, refresh);
  }
}

/* ---------- DELETE ---------- */
function removeChart(id) {
  const state = chartStates.get(id);
  if (!state) return;

  if (state.timer) clearInterval(state.timer);
  if (state.chart) state.chart.destroy();
  state.box.remove();
  chartStates.delete(id);
}
</script>

</body>
</html>
