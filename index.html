<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Form Data Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }

    h2 {
      text-align: center;
    }

    .controls {
      text-align: center;
      margin-bottom: 20px;
    }

    select, button, input[type=range] {
      margin: 6px;
      padding: 6px 10px;
    }

    .chart-wrapper {
      max-width: 1200px;
      margin: auto;
    }

    .chart-box {
      border: 1px solid #ccc;
      margin: 30px 0;
      padding: 10px;
    }

    .chart-header {
      text-align: right;
    }

    .chart-container {
      width: 100%;
      height: 400px;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>

<body>

<h2>Form Data Dashboard</h2>

<div class="controls">
  <label>X-axis:</label>
  <select id="xSelect"></select>

  <label>Y-axis:</label>
  <select id="ySelect"></select>

  <label>Chart Type:</label>
  <select id="chartType">
    <option value="bar">Bar</option>
    <option value="line">Line</option>
  </select>

  <button id="addChartBtn">Add Chart</button>
  <button id="refreshBtn">Refresh Data</button>
</div>

<div class="controls">
  <label>Chart Height:</label>
  <input type="range" id="sizeSlider" min="250" max="800" value="400">
  <span id="sizeValue">400px</span>
</div>

<div id="chartArea" class="chart-wrapper"></div>

<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbyn27BCQpW5oMmQHPEnr9256TTiMP449DT1cq8Uz4vXXI335XBocCS2NYsf-3lXVVG0AQ/exec";

let cachedData = null;
let charts = [];

async function fetchData() {
  const res = await fetch(apiUrl);
  const data = await res.json();
  const headers = Object.keys(data[0]);
  const dataRows = data.map(obj => Object.values(obj));
  cachedData = { headers, dataRows };
}

function populateSelectors(headers) {
  const x = document.getElementById("xSelect");
  const y = document.getElementById("ySelect");

  x.innerHTML = "";
  y.innerHTML = "";

  headers.forEach((h, i) => {
    x.add(new Option(h, i));
    y.add(new Option(h, i));
  });

  x.selectedIndex = 0;
  y.selectedIndex = 1;
}

function createChartBox() {
  const box = document.createElement("div");
  box.className = "chart-box";

  const header = document.createElement("div");
  header.className = "chart-header";

  const delBtn = document.createElement("button");
  delBtn.textContent = "Delete Chart";

  header.appendChild(delBtn);
  box.appendChild(header);

  const container = document.createElement("div");
  container.className = "chart-container";
  container.style.height = document.getElementById("sizeSlider").value + "px";

  const canvas = document.createElement("canvas");
  container.appendChild(canvas);
  box.appendChild(container);

  document.getElementById("chartArea").appendChild(box);

  const chart = buildChart(canvas);
  charts.push({ chart, container, box });

  delBtn.onclick = () => {
    chart.destroy();
    box.remove();
    charts = charts.filter(c => c.chart !== chart);
  };
}

function buildChart(canvas) {
  const { headers, dataRows } = cachedData;

  const xIndex = document.getElementById("xSelect").value;
  const yIndex = document.getElementById("ySelect").value;
  const type = document.getElementById("chartType").value;

  const labels = dataRows.map(r => r[xIndex]);
  const values = dataRows.map(r => parseFloat(r[yIndex]) || 0);

  return new Chart(canvas.getContext("2d"), {
    type,
    data: {
      labels,
      datasets: [{
        label: headers[yIndex],
        data: values,
        backgroundColor: "rgba(54,162,235,0.5)",
        borderColor: "rgba(54,162,235,1)",
        borderWidth: 2,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

function rebuildAllCharts() {
  charts.forEach(c => c.chart.destroy());
  const boxes = charts.map(c => c.box);
  charts = [];
  boxes.forEach(b => b.remove());
  createChartBox();
}

document.getElementById("addChartBtn").onclick = createChartBox;

document.getElementById("refreshBtn").onclick = async () => {
  await fetchData();
  rebuildAllCharts();
};

document.getElementById("chartType").onchange = rebuildAllCharts;
document.getElementById("xSelect").onchange = rebuildAllCharts;
document.getElementById("ySelect").onchange = rebuildAllCharts;

document.getElementById("sizeSlider").oninput = (e) => {
  document.getElementById("sizeValue").textContent = e.target.value + "px";
  charts.forEach(c => c.container.style.height = e.target.value + "px");
};

async function init() {
  await fetchData();
  populateSelectors(cachedData.headers);
  createChartBox();
}

init();
</script>

</body>
</html>
