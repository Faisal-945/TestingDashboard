<!DOCTYPE html>
<html>
<head>
  <title>Dynamic Form Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; margin: 30px; }
    h2 { text-align: center; }

    .chart-box {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin: 25px auto;
      max-width: 1000px;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    label {
      font-size: 0.9em;
    }

    select, input[type="range"] {
      width: 100%;
    }

    button {
      padding: 6px;
      cursor: pointer;
    }

    canvas {
      display: block;
      margin: 20px auto;
    }
  </style>
</head>
<body>

<h2>Form Data Dashboard</h2>
<button onclick="addChart()">âž• Add Chart</button>

<div id="charts"></div>

<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbyn27BCQpW5oMmQHPEnr9256TTiMP449DT1cq8Uz4vXXI335XBocCS2NYsf-3lXVVG0AQ/exec";

let chartCounter = 0;
const charts = new Map();

async function fetchData() {
  const res = await fetch(apiUrl);
  return await res.json();
}

function isNumericColumn(data, key) {
  for (let i = 0; i < Math.min(5, data.length); i++) {
    if (isNaN(parseFloat(data[i][key]))) return false;
  }
  return true;
}

async function addChart() {
  const data = await fetchData();
  const headers = Object.keys(data[0]);

  const id = ++chartCounter;
  const box = document.createElement("div");
  box.className = "chart-box";
  box.id = `chartBox-${id}`;

  box.innerHTML = `
    <div class="controls">
      <label>X-axis
        <select id="x-${id}"></select>
      </label>

      <label>Y-axis
        <select id="y-${id}"></select>
      </label>

      <label>Chart Type
        <select id="type-${id}">
          <option value="bar">Bar</option>
          <option value="line">Line</option>
        </select>
      </label>

      <label>Data Points
        <select id="limit-${id}">
          <option>5</option>
          <option selected>10</option>
          <option>15</option>
          <option>20</option>
          <option>25</option>
          <option>30</option>
          <option>40</option>
          <option>50</option>
        </select>
      </label>

      <label>Refresh Rate
        <select id="refresh-${id}">
          <option value="0">Off</option>
          <option value="5000">5 sec</option>
          <option value="10000">10 sec</option>
          <option value="30000">30 sec</option>
        </select>
      </label>

      <label>Chart Size
        <input type="range" min="300" max="900" value="500" id="size-${id}">
      </label>

      <button onclick="deleteChart(${id})">ðŸ—‘ Delete</button>
    </div>

    <canvas id="canvas-${id}" width="500" height="300"></canvas>
  `;

  document.getElementById("charts").appendChild(box);

  const xSel = box.querySelector(`#x-${id}`);
  const ySel = box.querySelector(`#y-${id}`);

  headers.forEach(h => {
    xSel.add(new Option(h, h));
    if (isNumericColumn(data, h)) {
      ySel.add(new Option(h, h));
    }
  });

  const ctx = box.querySelector("canvas").getContext("2d");
  const chart = new Chart(ctx, {
    type: "bar",
    data: { labels: [], datasets: [{ label: "", data: [] }] },
    options: { responsive: false }
  });

  charts.set(id, { chart, timer: null });

  [
    `x-${id}`, `y-${id}`, `type-${id}`,
    `limit-${id}`, `refresh-${id}`
  ].forEach(cid => {
    box.querySelector(`#${cid}`).addEventListener("change", () => updateChart(id));
  });

  box.querySelector(`#size-${id}`).addEventListener("input", e => {
    const size = e.target.value;
    const canvas = box.querySelector("canvas");
    canvas.width = size;
    canvas.height = size * 0.6;
    chart.resize();
  });

  updateChart(id);
}

async function updateChart(id) {
  const box = document.getElementById(`chartBox-${id}`);
  const state = charts.get(id);
  if (!state) return;

  if (state.timer) {
    clearInterval(state.timer);
    state.timer = null;
  }

  const xKey = box.querySelector(`#x-${id}`).value;
  const yKey = box.querySelector(`#y-${id}`).value;
  const type = box.querySelector(`#type-${id}`).value;
  const limit = parseInt(box.querySelector(`#limit-${id}`).value);
  const refresh = parseInt(box.querySelector(`#refresh-${id}`).value);

  const redraw = async () => {
    const data = await fetchData();
    const sliced = data.slice(-limit);

    state.chart.config.type = type;
    state.chart.data.labels = sliced.map(r => r[xKey]);
    state.chart.data.datasets[0].label = yKey;
    state.chart.data.datasets[0].data = sliced.map(r => parseFloat(r[yKey]) || 0);
    state.chart.update();
  };

  await redraw();

  if (refresh > 0) {
    state.timer = setInterval(redraw, refresh);
  }
}

function deleteChart(id) {
  const state = charts.get(id);
  if (!state) return;

  if (state.timer) clearInterval(state.timer);
  state.chart.destroy();
  charts.delete(id);

  document.getElementById(`chartBox-${id}`).remove();
}
</script>

</body>
</html>
