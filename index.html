<!DOCTYPE html>
<html>
<head>
  <title>Form Data Dashboard</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>

  <style>
    body { font-family: Arial; margin: 30px; }
    h2 { text-align: center; }

    .chart-box {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin: 25px auto;
      max-width: 1200px;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    .chart-container {
      position: relative;
      height: 450px;   /* THIS controls size now */
      width: 100%;
    }

    button { cursor: pointer; }
  </style>
</head>
<body>

<h2>Form Data Dashboard</h2>
<button onclick="addChart()">âž• Add Chart</button>

<div id="charts"></div>

<script>
const apiUrl =
  "https://script.google.com/macros/s/AKfycbyn27BCQpW5oMmQHPEnr9256TTiMP449DT1cq8Uz4vXXI335XBocCS2NYsf-3lXVVG0AQ/exec";

let chartId = 0;
const chartStates = new Map();

/* ---------------- HELPERS ---------------- */
function parseTimestamp(str) {
  if (!str) return null;
  const [date, time] = str.split(" ");
  const [d, m, y] = date.split("/");
  return new Date(`${y}-${m}-${d}T${time}`);
}

async function fetchData() {
  const res = await fetch(apiUrl);
  return await res.json();
}

function isNumeric(data, key) {
  for (let i = 0; i < Math.min(5, data.length); i++) {
    if (isNaN(parseFloat(data[i][key]))) return false;
  }
  return true;
}

/* ---------------- CREATE ---------------- */
async function addChart() {
  const data = await fetchData();
  const headers = Object.keys(data[0]);
  const timestampKey = headers[0]; // assumes first column is timestamp

  const id = ++chartId;

  const box = document.createElement("div");
  box.className = "chart-box";
  box.id = `chart-${id}`;

  box.innerHTML = `
    <div class="controls">
      <label>Y-axis
        <select class="y"></select>
      </label>

      <label>Chart Type
        <select class="type">
          <option value="line">Line</option>
          <option value="bar">Bar</option>
        </select>
      </label>

      <label>Points
        <select class="limit">
          <option>5</option>
          <option selected>10</option>
          <option>15</option>
          <option>20</option>
          <option>30</option>
          <option>50</option>
        </select>
      </label>

      <label>Refresh
        <select class="refresh">
          <option value="0">Off</option>
          <option value="5000">5s</option>
          <option value="10000">10s</option>
          <option value="30000">30s</option>
        </select>
      </label>

      <button class="delete">ðŸ—‘ Delete</button>
    </div>

    <div class="chart-container">
      <canvas></canvas>
    </div>
  `;

  document.getElementById("charts").appendChild(box);

  const ySel = box.querySelector(".y");
  headers.forEach(h => {
    if (isNumeric(data, h)) ySel.add(new Option(h, h));
  });

  const state = {
    id,
    box,
    canvas: box.querySelector("canvas"),
    chart: null,
    timer: null,
    timestampKey
  };

  chartStates.set(id, state);

  box.querySelectorAll("select").forEach(el =>
    el.addEventListener("change", () => rebuildChart(id))
  );

  box.querySelector(".delete").onclick = () => removeChart(id);

  rebuildChart(id);
}

/* ---------------- BUILD ---------------- */
async function rebuildChart(id) {
  const state = chartStates.get(id);
  if (!state) return;

  if (state.timer) clearInterval(state.timer);
  if (state.chart) state.chart.destroy();

  const box = state.box;
  const yKey = box.querySelector(".y").value;
  const type = box.querySelector(".type").value;
  const limit = +box.querySelector(".limit").value;
  const refresh = +box.querySelector(".refresh").value;

  async function draw() {
    const raw = await fetchData();
    const sliced = raw.slice(-limit);

    const points = sliced
      .map(r => ({
        x: parseTimestamp(r[state.timestampKey]),
        y: parseFloat(r[yKey])
      }))
      .filter(p => p.x && !isNaN(p.y));

    state.chart = new Chart(state.canvas, {
      type,
      data: {
        datasets: [{
          label: yKey,
          data: points,
          borderWidth: 2
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            type: "time",
            time: {
              tooltipFormat: "dd MMM yyyy HH:mm:ss"
            },
            ticks: {
              callback: value =>
                new Date(value).toLocaleTimeString([], {
                  hour: "2-digit",
                  minute: "2-digit"
                })
            },
            title: { display: true, text: "Time" }
          },
          y: {
            beginAtZero: true,
            title: { display: true, text: yKey }
          }
        }
      }
    });
  }

  await draw();

  if (refresh > 0) {
    state.timer = setInterval(async () => {
      if (state.chart) state.chart.destroy();
      await draw();
    }, refresh);
  }
}

/* ---------------- DELETE ---------------- */
function removeChart(id) {
  const state = chartStates.get(id);
  if (!state) return;

  if (state.timer) clearInterval(state.timer);
  if (state.chart) state.chart.destroy();
  state.box.remove();
  chartStates.delete(id);
}
</script>

</body>
</html>
