<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Form Data Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }

    h2 {
      text-align: center;
    }

    button, select {
      padding: 5px 8px;
      margin: 4px;
    }

    .global-controls {
      text-align: center;
      margin-bottom: 20px;
    }

    .chart-box {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 30px 0;
    }

    .chart-controls {
      text-align: center;
      margin-bottom: 10px;
    }

    .chart-container {
      width: 100%;
      height: 400px;
    }

    canvas {
      width: 100% !important;
      height: 100% !important;
    }
  </style>
</head>

<body>

<h2>Form Data Dashboard</h2>

<div class="global-controls">
  <button id="addChartBtn">Add Chart</button>
  <button id="refreshBtn">Refresh Data</button>
</div>

<div id="chartArea"></div>

<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbyn27BCQpW5oMmQHPEnr9256TTiMP449DT1cq8Uz4vXXI335XBocCS2NYsf-3lXVVG0AQ/exec";

let cachedData = null;

async function fetchData() {
  const res = await fetch(apiUrl);
  const data = await res.json();
  const headers = Object.keys(data[0]);
  const rows = data.map(obj => Object.values(obj));
  cachedData = { headers, rows };
}

function createChartBox() {
  const box = document.createElement("div");
  box.className = "chart-box";

  const controls = document.createElement("div");
  controls.className = "chart-controls";

  const xSelect = document.createElement("select");
  const ySelect = document.createElement("select");
  const typeSelect = document.createElement("select");

  ["bar", "line"].forEach(t => {
    typeSelect.add(new Option(t.toUpperCase(), t));
  });

  cachedData.headers.forEach((h, i) => {
    xSelect.add(new Option("X: " + h, i));
    ySelect.add(new Option("Y: " + h, i));
  });

  ySelect.selectedIndex = 1;

  const delBtn = document.createElement("button");
  delBtn.textContent = "Delete Chart";

  controls.append(xSelect, ySelect, typeSelect, delBtn);
  box.appendChild(controls);

  const container = document.createElement("div");
  container.className = "chart-container";

  const canvas = document.createElement("canvas");
  container.appendChild(canvas);
  box.appendChild(container);

  document.getElementById("chartArea").appendChild(box);

  let chart = buildChart(canvas, xSelect.value, ySelect.value, typeSelect.value);

  function rebuild() {
    chart.destroy();
    chart = buildChart(canvas, xSelect.value, ySelect.value, typeSelect.value);
  }

  xSelect.onchange = rebuild;
  ySelect.onchange = rebuild;
  typeSelect.onchange = rebuild;

  delBtn.onclick = () => {
    chart.destroy();
    box.remove();
  };
}

function buildChart(canvas, xIndex, yIndex, type) {
  const labels = cachedData.rows.map(r => r[xIndex]);
  const values = cachedData.rows.map(r => parseFloat(r[yIndex]) || 0);

  return new Chart(canvas.getContext("2d"), {
    type,
    data: {
      labels,
      datasets: [{
        label: cachedData.headers[yIndex],
        data: values,
        backgroundColor: "rgba(54,162,235,0.5)",
        borderColor: "rgba(54,162,235,1)",
        borderWidth: 2,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: { beginAtZero: true }
      }
    }
  });
}

document.getElementById("addChartBtn").onclick = createChartBox;

document.getElementById("refreshBtn").onclick = async () => {
  await fetchData();
  document.getElementById("chartArea").innerHTML = "";
  createChartBox();
};

async function init() {
  await fetchData();
  createChartBox();
}

init();
</script>

</body>
</html>
