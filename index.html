<!DOCTYPE html>
<html>
<head>
  <title>Dynamic Form Dashboard</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { font-family: Arial; margin: 30px; }
    h2 { text-align: center; }

    .chart-box {
      border: 1px solid #ccc;
      border-radius: 8px;
      padding: 15px;
      margin: 25px auto;
      max-width: 1100px;
    }

    .controls {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 10px;
      margin-bottom: 10px;
    }

    canvas {
      display: block;
      margin: 20px auto;
    }

    button { cursor: pointer; }
  </style>
</head>
<body>

<h2>Form Data Dashboard</h2>
<button onclick="addChart()">âž• Add Chart</button>

<div id="charts"></div>

<script>
const apiUrl = "https://script.google.com/macros/s/AKfycbyn27BCQpW5oMmQHPEnr9256TTiMP449DT1cq8Uz4vXXI335XBocCS2NYsf-3lXVVG0AQ/exec";

let chartId = 0;
const chartStates = new Map();

/* ------------------ DATA ------------------ */
async function fetchData() {
  const res = await fetch(apiUrl);
  return await res.json();
}

function isNumeric(data, key) {
  for (let i = 0; i < Math.min(5, data.length); i++) {
    if (isNaN(parseFloat(data[i][key]))) return false;
  }
  return true;
}

/* ------------------ CREATE ------------------ */
async function addChart() {
  const data = await fetchData();
  const headers = Object.keys(data[0]);
  const id = ++chartId;

  const box = document.createElement("div");
  box.className = "chart-box";
  box.id = `chart-${id}`;

  box.innerHTML = `
    <div class="controls">
      <label>X
        <select class="x"></select>
      </label>

      <label>Y
        <select class="y"></select>
      </label>

      <label>Type
        <select class="type">
          <option value="bar">Bar</option>
          <option value="line">Line</option>
        </select>
      </label>

      <label>Points
        <select class="limit">
          <option>5</option>
          <option selected>10</option>
          <option>15</option>
          <option>20</option>
          <option>30</option>
          <option>50</option>
        </select>
      </label>

      <label>Refresh
        <select class="refresh">
          <option value="0">Off</option>
          <option value="5000">5s</option>
          <option value="10000">10s</option>
          <option value="30000">30s</option>
        </select>
      </label>

      <label>Size
        <input type="range" class="size" min="400" max="900" value="600">
      </label>

      <button class="delete">ðŸ—‘ Delete</button>
    </div>

    <canvas></canvas>
  `;

  document.getElementById("charts").appendChild(box);

  const xSel = box.querySelector(".x");
  const ySel = box.querySelector(".y");

  headers.forEach(h => {
    xSel.add(new Option(h, h));
    if (isNumeric(data, h)) ySel.add(new Option(h, h));
  });

  const canvas = box.querySelector("canvas");
  const ctx = canvas.getContext("2d");

  const state = {
    id,
    box,
    canvas,
    ctx,
    chart: null,
    timer: null,
    width: 600,
    height: 360
  };

  chartStates.set(id, state);

  box.querySelectorAll("select").forEach(el =>
    el.addEventListener("change", () => rebuildChart(id))
  );

  box.querySelector(".size").addEventListener("input", e => {
    state.width = e.target.value;
    state.height = state.width * 0.6;
    applySize(state);
  });

  box.querySelector(".delete").onclick = () => removeChart(id);

  rebuildChart(id);
}

/* ------------------ CHART ------------------ */
function applySize(state) {
  state.canvas.width = state.width;
  state.canvas.height = state.height;
  if (state.chart) state.chart.resize();
}

async function rebuildChart(id) {
  const state = chartStates.get(id);
  if (!state) return;

  if (state.timer) {
    clearInterval(state.timer);
    state.timer = null;
  }

  if (state.chart) {
    state.chart.destroy();
    state.chart = null;
  }

  applySize(state);

  const box = state.box;
  const xKey = box.querySelector(".x").value;
  const yKey = box.querySelector(".y").value;
  const type = box.querySelector(".type").value;
  const limit = +box.querySelector(".limit").value;
  const refresh = +box.querySelector(".refresh").value;

  async function draw() {
    const data = await fetchData();
    const sliced = data.slice(-limit);

    state.chart = new Chart(state.ctx, {
      type,
      data: {
        labels: sliced.map(r => r[xKey]),
        datasets: [{
          label: yKey,
          data: sliced.map(r => parseFloat(r[yKey]) || 0)
        }]
      },
      options: {
        responsive: false,
        scales: { y: { beginAtZero: true } }
      }
    });
  }

  await draw();

  if (refresh > 0) {
    state.timer = setInterval(async () => {
      if (state.chart) state.chart.destroy();
      await draw();
    }, refresh);
  }
}

/* ------------------ DELETE ------------------ */
function removeChart(id) {
  const state = chartStates.get(id);
  if (!state) return;

  if (state.timer) clearInterval(state.timer);
  if (state.chart) state.chart.destroy();
  state.box.remove();
  chartStates.delete(id);
}
</script>

</body>
</html>
